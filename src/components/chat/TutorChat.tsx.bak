import React, { useState, useEffect } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { 
  MessageCircle, Bot, Search, ChevronLeft, Filter, 
  SlidersHorizontal, Clock, User, Sparkles, Calendar,
  Bookmark, RotateCcw, Book, Send, Plus
} from 'lucide-react';
import { UserAvatar } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import ChatInterface from './ChatInterface';
import { AVAILABLE_MODELS } from '@/api/openrouter';
import StudentMessage from './StudentMessage';
import TypingIndicator from './TypingIndicator';

// Dữ liệu mẫu cho danh sách sinh viên
const MOCK_STUDENTS = [
  {
    id: '1',
    name: 'Nguyễn Văn A',
    avatar: 'https://i.pravatar.cc/150?img=1',
    lastMessage: 'Thầy ơi, em có thắc mắc về bài tập số 3',
    timestamp: '10:32 AM',
    course: 'Mạch Logic',
    unread: 3,
    online: true
  },
  {
    id: '2',
    name: 'Trần Thị B',
    avatar: 'https://i.pravatar.cc/150?img=2',
    lastMessage: 'Em đã nộp bài tập rồi ạ',
    timestamp: 'Hôm qua',
    course: 'Hệ thống số',
    unread: 0,
    online: false
  },
  {
    id: '3',
    name: 'Lê Văn C',
    avatar: 'https://i.pravatar.cc/150?img=3',
    lastMessage: 'Em cảm ơn thầy nhiều',
    timestamp: 'Thứ 2',
    course: 'Vi xử lý',
    unread: 0,
    online: true
  },
  {
    id: '4',
    name: 'Phạm Thị D',
    avatar: 'https://i.pravatar.cc/150?img=4',
    lastMessage: 'Em không hiểu bài giảng hôm nay lắm',
    timestamp: 'Chủ nhật',
    course: 'Mạch Logic',
    unread: 1,
    online: false
  }
];

// Dữ liệu mẫu cho các tin nhắn chat với sinh viên
const MOCK_MESSAGES = [
  {
    id: '1',
    content: 'Chào thầy, em đang làm bài tập về mạch JK Flip-Flop nhưng gặp vấn đề ở phần tính toán bảng trạng thái',
    timestamp: new Date(Date.now() - 3600000).toISOString(),
    sender: 'student',
    senderName: 'Nguyễn Văn A',
    senderAvatar: 'https://i.pravatar.cc/150?img=1',
  },
  {
    id: '2',
    content: 'Em chào, JK Flip-Flop là loại flip-flop có bảng trạng thái khá đặc biệt. Em gặp khó khăn cụ thể ở phần nào vậy?',
    timestamp: new Date(Date.now() - 3540000).toISOString(),
    sender: 'tutor',
    senderName: 'TS. Nguyễn Tuấn Anh',
    senderAvatar: 'https://i.pravatar.cc/150?img=10',
  },
  {
    id: '3',
    content: 'Em không hiểu khi J=K=1 thì tại sao lại toggle trạng thái ạ? Và làm sao để tính trạng thái kế tiếp?',
    timestamp: new Date(Date.now() - 3480000).toISOString(),
    sender: 'student',
    senderName: 'Nguyễn Văn A',
    senderAvatar: 'https://i.pravatar.cc/150?img=1',
  },
  {
    id: '4',
    content: 'Đó là đặc điểm của JK Flip-Flop. Khi J=K=1, FF sẽ chuyển sang trạng thái đối ngược với trạng thái hiện tại:\n\n- Nếu Q(t) = 0 thì Q(t+1) = 1\n- Nếu Q(t) = 1 thì Q(t+1) = 0\n\nĐể tính trạng thái kế tiếp, em dùng công thức: Q(t+1) = J·Q̅(t) + K̅·Q(t)\n\nEm có thể xây dựng bảng sự thật để dễ hiểu hơn:\n\nJ K | Q(t) | Q(t+1)\n-----------------\n0 0 |  0   |   0\n0 0 |  1   |   1\n0 1 |  0   |   0\n0 1 |  1   |   0\n1 0 |  0   |   1\n1 0 |  1   |   1\n1 1 |  0   |   1\n1 1 |  1   |   0',
    timestamp: new Date(Date.now() - 3420000).toISOString(),
    sender: 'tutor',
    senderName: 'TS. Nguyễn Tuấn Anh',
    senderAvatar: 'https://i.pravatar.cc/150?img=10',
  }
];

// Dữ liệu mẫu cho gợi ý câu hỏi AI
const MOCK_AI_SUGGESTIONS = [
  "Hướng dẫn giảng dạy về mạch đếm nhị phân là gì?",
  "Cách tạo bài tập về bản đồ Karnaugh cho sinh viên",
  "Phương pháp dạy về JK Flip-Flop hiệu quả nhất",
  "Giải thích về cổng NAND và NOR cho sinh viên mới"
];

// Dữ liệu mẫu cho lịch sử chat với AI
const MOCK_AI_HISTORY = [
  {
    id: '1',
    title: 'Phương pháp giảng dạy mạch logic',
    timestamp: 'Hôm nay, 10:24'
  },
  {
    id: '2',
    title: 'Tạo đề thi giữa kỳ môn Vi xử lý',
    timestamp: 'Hôm qua'
  },
  {
    id: '3',
    title: 'Câu hỏi về phương pháp dạy học',
    timestamp: '23/05/2023'
  }
];

interface TutorChatProps {
  studentId?: string;
  courseId: string;
}

const TutorChat: React.FC<TutorChatProps> = ({ studentId, courseId }) => {
  const [activeTab, setActiveTab] = useState<'student' | 'ai'>('student');
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedStudent, setSelectedStudent] = useState<string | null>(studentId || null);
  const [selectedModel, setSelectedModel] = useState(AVAILABLE_MODELS[0]);
  const [showModelSelect, setShowModelSelect] = useState(false);
  const [newMessage, setNewMessage] = useState('');
  const [currentMessages, setCurrentMessages] = useState(MOCK_MESSAGES);
  const [filteredStudents, setFilteredStudents] = useState(MOCK_STUDENTS);
  const [isMobileView, setIsMobileView] = useState(false);
  const [showChatList, setShowChatList] = useState(true);
  
  // Lọc sinh viên theo từ khóa tìm kiếm
  useEffect(() => {
    const filtered = MOCK_STUDENTS.filter(student => 
      student.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      student.course.toLowerCase().includes(searchQuery.toLowerCase())
    );
    setFilteredStudents(filtered);
  }, [searchQuery]);
  
  // Kiểm tra kích thước màn hình để thay đổi layout
  useEffect(() => {
    const handleResize = () => {
      setIsMobileView(window.innerWidth < 768);
    };
    
    handleResize();
    window.addEventListener('resize', handleResize);
    
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);
  
  // Xử lý khi chọn sinh viên
  const handleSelectStudent = (id: string) => {
    setSelectedStudent(id);
    if (isMobileView) {
      setShowChatList(false);
    }
  };
  
  // Xử lý gửi tin nhắn
  const handleSendMessage = () => {
    if (!newMessage.trim()) return;
    
    const newMsg = {
      id: Date.now().toString(),
      content: newMessage,
      timestamp: new Date().toISOString(),
      sender: 'tutor' as const,
      senderName: 'TS. Nguyễn Tuấn Anh',
      senderAvatar: 'https://i.pravatar.cc/150?img=10',
    };
    
    setCurrentMessages(prev => [...prev, newMsg]);
    setNewMessage('');
  };
  
  // Hiển thị giao diện chat với sinh viên
  const renderStudentChat = () => {
    return (
      <div className="flex h-full overflow-hidden">
        {/* Danh sách sinh viên */}
        {(showChatList || !isMobileView) && (
          <div className="w-full md:w-80 border-r border-border overflow-y-auto bg-gray-50 flex flex-col">
            <div className="p-4 sticky top-0 bg-white z-10 border-b border-gray-200">
              <h3 className="font-semibold text-lg mb-3">Danh sách sinh viên</h3>
              <div className="relative">
                <Input
                  placeholder="Tìm kiếm sinh viên..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9"
                />
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
              </div>
              <div className="flex items-center gap-2 mt-3">
                <div className="flex gap-1 items-center text-xs text-gray-500">
                  <Filter size={12} />
                  <span>Lọc</span>
                </div>
                <div className="h-4 border-r border-gray-300"></div>
                <div className="flex gap-1 items-center text-xs text-gray-500">
                  <SlidersHorizontal size={12} />
                  <span>Sắp xếp</span>
                </div>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto divide-y divide-gray-100">
              {filteredStudents.map(student => (
                <div 
                  key={student.id}
                  className={cn(
                    "p-3 flex items-start gap-3 hover:bg-gray-100 cursor-pointer transition-colors",
                    selectedStudent === student.id && "bg-gray-100"
                  )}
                  onClick={() => handleSelectStudent(student.id)}
                >
                  <div className="relative flex-shrink-0">
                    <UserAvatar 
                      src={student.avatar} 
                      alt={student.name}
                      size="md"
                      online={student.online}
                    />
                  </div>
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-start">
                      <h3 className="font-medium text-sm truncate">{student.name}</h3>
                      <span className="text-xs text-gray-500 whitespace-nowrap">{student.timestamp}</span>
                    </div>
                    <p className="text-xs text-gray-500 truncate">{student.lastMessage}</p>
                    <div className="flex items-center justify-between mt-1">
                      <Badge variant="outline" className="text-xs bg-gray-50 text-gray-700 px-1.5 py-0">
                        {student.course}
                      </Badge>
                      
                      {student.unread > 0 && (
                        <Badge className="bg-red-500 hover:bg-red-600 h-5 w-5 flex items-center justify-center p-0 rounded-full">
                          {student.unread}
                        </Badge>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {/* Giao diện chat */}
        {selectedStudent ? (
          <div className="flex-1 flex flex-col h-full overflow-hidden">
            {/* Header chat */}
            <div className="h-16 border-b border-border flex items-center px-4 bg-white sticky top-0 z-10">
              {isMobileView && !showChatList && (
                <Button 
                  variant="ghost" 
                  size="icon" 
                  className="mr-2" 
                  onClick={() => setShowChatList(true)}
                >
                  <ChevronLeft size={18} />
                </Button>
              )}
              
              <div className="flex items-center gap-3">
                <UserAvatar
                  src={MOCK_STUDENTS.find(s => s.id === selectedStudent)?.avatar}
                  alt={MOCK_STUDENTS.find(s => s.id === selectedStudent)?.name || ''}
                  size="sm"
                  online={MOCK_STUDENTS.find(s => s.id === selectedStudent)?.online}
                />
                
                <div>
                  <h3 className="font-medium text-sm">
                    {MOCK_STUDENTS.find(s => s.id === selectedStudent)?.name}
                  </h3>
                  <div className="flex items-center gap-1">
                    <span className="text-xs text-gray-500">
                      {MOCK_STUDENTS.find(s => s.id === selectedStudent)?.course}
                    </span>
                    <span className="text-gray-400">•</span>
                    <span className="text-xs text-gray-500 flex items-center gap-1">
                      <Clock size={10} />
                      Hoạt động gần đây
                    </span>
                  </div>
                </div>
              </div>
              
              <div className="ml-auto flex gap-2">
                <Button variant="outline" size="sm" className="text-xs">
                  <Calendar size={14} className="mr-1" />
                  Lịch hẹn
                </Button>
                <Button variant="outline" size="sm" className="text-xs">
                  <User size={14} className="mr-1" />
                  Hồ sơ
                </Button>
              </div>
            </div>
            
            {/* Nội dung chat */}
            <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
              <div className="max-w-3xl mx-auto flex flex-col gap-6">
                {currentMessages.map(message => (
                  <StudentMessage 
                    key={message.id}
                    content={message.content}
                    timestamp={message.timestamp}
                    sender={message.sender}
                    senderName={message.senderName}
                    senderAvatar={message.senderAvatar}
                    isTutorView={true}
                  />
                ))}
              </div>
            </div>
            
            {/* Input chat */}
            <div className="p-4 border-t border-border bg-white">
              <div className="max-w-3xl mx-auto">
                <div className="flex items-end bg-white border border-gray-200 rounded-lg overflow-hidden">
                  <textarea 
                    value={newMessage}
                    onChange={(e) => setNewMessage(e.target.value)}
                    placeholder="Nhập tin nhắn cho sinh viên..."
                    className="flex-1 border-0 resize-none p-3 focus:outline-none focus:ring-0 max-h-32 text-sm"
                    rows={1}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                      }
                    }}
                  />
                  
                  <div className="flex items-center p-2 gap-1">
                    <Button 
                      size="icon" 
                      variant="ghost" 
                      className="rounded-full h-8 w-8"
                    >
                      <Plus size={18} />
                    </Button>
                    <Button 
                      size="icon" 
                      variant="ghost" 
                      className="rounded-full h-8 w-8"
                    >
                      <Bookmark size={18} />
                    </Button>
                    <Button 
                      size="icon"
                      variant="default"
                      className={cn(
                        "rounded-full h-8 w-8",
                        !newMessage.trim() && "opacity-50 cursor-not-allowed"
                      )}
                      disabled={!newMessage.trim()}
                      onClick={handleSendMessage}
                    >
                      <Send size={16} />
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="flex-1 flex items-center justify-center bg-gray-50">
            <div className="text-center p-8">
              <div className="h-16 w-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center mx-auto mb-4">
                <MessageCircle size={24} />
              </div>
              <h3 className="text-lg font-medium mb-2">Chọn một sinh viên để bắt đầu</h3>
              <p className="text-gray-500 max-w-md">
                Chọn một sinh viên từ danh sách để bắt đầu cuộc trò chuyện và hỗ trợ họ với các vấn đề học tập.
              </p>
            </div>
          </div>
        )}
      </div>
    );
  };
  
  // Hiển thị giao diện chat với AI
  const renderAIChat = () => {
    return (
      <div className="flex h-full overflow-hidden">
        {/* Sidebar AI Assistant */}
        <div className="w-full md:w-80 border-r border-border overflow-y-auto bg-gray-50 flex flex-col">
          <div className="p-4 sticky top-0 bg-white z-10 border-b border-gray-200">
            <h3 className="font-semibold text-lg mb-3">AI Assistant</h3>
            
            {/* Model selector */}
            <div className="relative mb-3">
              <div 
                onClick={() => setShowModelSelect(!showModelSelect)}
                className="flex items-center justify-between p-2.5 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50"
              >
                <div className="flex items-center gap-2">
                  <Bot size={18} className="text-tutu-600" />
                  <span className="text-sm font-medium">{selectedModel.name}</span>
                </div>
                <SlidersHorizontal size={14} className="text-gray-500" />
              </div>
              
              {showModelSelect && (
                <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20">
                  <div className="p-2 max-h-64 overflow-y-auto">
                    {AVAILABLE_MODELS.map(model => (
                      <div 
                        key={model.id}
                        className="p-2 hover:bg-gray-50 rounded cursor-pointer"
                        onClick={() => {
                          setSelectedModel(model);
                          setShowModelSelect(false);
                        }}
                      >
                        <div className="text-sm font-medium">{model.name}</div>
                        <div className="text-xs text-gray-500">{model.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            {/* Chat mới */}
            <Button 
              variant="default" 
              className="w-full mb-3 bg-tutu-600 hover:bg-tutu-700 text-black"
            >
              <Sparkles size={16} className="mr-2" />
              Chat mới
            </Button>
            
            {/* Gợi ý câu hỏi */}
            <h4 className="text-xs font-medium text-gray-500 uppercase mb-2">Gợi ý</h4>
            <div className="space-y-2 mb-4">
              {MOCK_AI_SUGGESTIONS.map((suggestion, index) => (
                <div 
                  key={index}
                  className="p-2 text-xs rounded-lg border border-gray-200 bg-white hover:bg-gray-50 cursor-pointer transition-colors"
                >
                  {suggestion}
                </div>
              ))}
            </div>
          </div>
          
          {/* Lịch sử chat với AI */}
          <div className="flex-1 overflow-y-auto p-3">
            <h4 className="text-xs font-medium text-gray-500 uppercase mb-2 px-1">Lịch sử chat</h4>
            <div className="space-y-1">
              {MOCK_AI_HISTORY.map(item => (
                <div 
                  key={item.id}
                  className="p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors"
                >
                  <div className="flex items-center gap-2">
                    <Clock size={12} className="text-gray-400" />
                    <span className="text-xs text-gray-400">{item.timestamp}</span>
                  </div>
                  <div className="text-sm mt-1 line-clamp-1">{item.title}</div>
                </div>
              ))}
            </div>
          </div>
          
          {/* Thông tin AI */}
          <div className="p-3 border-t border-gray-200">
            <div className="p-3 rounded-lg bg-tutu-50 border border-tutu-100">
              <div className="flex items-center gap-2 mb-2">
                <Bot size={16} className="text-tutu-600" />
                <h4 className="text-sm font-medium text-tutu-700">Thông tin AI Assistant</h4>
              </div>
              <p className="text-xs text-gray-600">
                AI Assistant được thiết kế để hỗ trợ giảng dạy về mạch điện tử và điện tử số. 
                Bạn có thể hỏi các câu hỏi về phương pháp giảng dạy, tạo tài liệu, và nhiều hơn nữa.
              </p>
            </div>
          </div>
        </div>
        
        {/* Giao diện chat với AI */}
        <div className="flex-1 flex flex-col h-full overflow-hidden">
          {/* Header AI chat */}
          <div className="h-16 border-b border-border flex items-center px-4 bg-white sticky top-0 z-10">
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-tutu-100 flex items-center justify-center">
                <Bot size={16} className="text-tutu-600" />
              </div>
              
              <div>
                <h3 className="font-medium text-sm">AI Assistant</h3>
                <div className="flex items-center gap-1">
                  <span className="text-xs text-gray-500">
                    {selectedModel.name}
                  </span>
                </div>
              </div>
            </div>
            
            <div className="ml-auto flex gap-2">
              <Button variant="outline" size="sm" className="text-xs">
                <RotateCcw size={14} className="mr-1" />
                Làm mới
              </Button>
              <Button variant="outline" size="sm" className="text-xs">
                <Book size={14} className="mr-1" />
                Tài liệu
              </Button>
            </div>
          </div>
          
          {/* AI Chat Interface */}
          <ChatInterface
            selectedModel={selectedModel}
            tutorMode={true}
          />
        </div>
      </div>
    );
  };
  
  return (
    <div className="flex flex-col h-full">
      <Tabs 
        defaultValue="student" 
        className="w-full h-full flex flex-col"
        value={activeTab}
        onValueChange={(value) => setActiveTab(value as 'student' | 'ai')}
      >
        <div className="border-b px-4 py-2 bg-white">
          <TabsList className="grid grid-cols-2 w-full max-w-md mx-auto">
            <TabsTrigger value="student" className="flex items-center gap-2 data-[state=active]:bg-tutu-50 data-[state=active]:text-tutu-800">
              <MessageCircle size={18} />
              <span>Chat với sinh viên</span>
            </TabsTrigger>
            <TabsTrigger value="ai" className="flex items-center gap-2 data-[state=active]:bg-tutu-50 data-[state=active]:text-tutu-800">
              <Bot size={18} />
              <span>Hỏi AI</span>
            </TabsTrigger>
          </TabsList>
        </div>
        
        <TabsContent value="student" className="flex-1 p-0 m-0 outline-none">
          {renderStudentChat()}
        </TabsContent>
        
        <TabsContent value="ai" className="flex-1 p-0 m-0 outline-none">
          {renderAIChat()}
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default TutorChat; 